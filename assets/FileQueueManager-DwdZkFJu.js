import{r as e,s,j as a,v as t,w as r,I as n,x as i,y as l,z as d,E as o,F as c,G as m,H as f}from"./ui-vendor-B50KzqUP.js";import{r as u}from"./react-vendor-xmALwEl6.js";import{d as x,u as h,B as p,s as g,C as j,a as k,b as v,e as N}from"./index-pAwTUmbv.js";import{C as y,L as w,a as C,P as b,b as _}from"./label-Dn_Iw-YU.js";import{C as F,a as q,S as R,P as S,R as z}from"./switch-CylB-6ol.js";import{D as K}from"./download-BYd_rWdu.js";import{u as $}from"./query-vendor-CSOQ5a_6.js";import{B as D}from"./badge-Dz51AyLj.js";import{C as P}from"./circle-check-DKVmP6Q0.js";import{C as A}from"./circle-alert-CS47a3vq.js";const H=e,I=s;u.forwardRef(({className:e,inset:s,children:t,...r},n)=>a.jsxs(i,{ref:n,className:x("flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none data-[state=open]:bg-accent focus:bg-accent",s&&"pl-8",e),...r,children:[t,a.jsx(y,{className:"ml-auto h-4 w-4"})]})).displayName=i.displayName;u.forwardRef(({className:e,...s},t)=>a.jsx(l,{ref:t,className:x("z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",e),...s})).displayName=l.displayName;const M=u.forwardRef(({className:e,sideOffset:s=4,...n},i)=>a.jsx(t,{children:a.jsx(r,{ref:i,sideOffset:s,className:x("z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",e),...n})}));M.displayName=r.displayName;const B=u.forwardRef(({className:e,inset:s,...t},r)=>a.jsx(n,{ref:r,className:x("relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none transition-colors data-[disabled]:pointer-events-none data-[disabled]:opacity-50 focus:bg-accent focus:text-accent-foreground",s&&"pl-8",e),...t}));B.displayName=n.displayName;u.forwardRef(({className:e,children:s,checked:t,...r},n)=>a.jsxs(d,{ref:n,className:x("relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors data-[disabled]:pointer-events-none data-[disabled]:opacity-50 focus:bg-accent focus:text-accent-foreground",e),checked:t,...r,children:[a.jsx("span",{className:"absolute left-2 flex h-3.5 w-3.5 items-center justify-center",children:a.jsx(o,{children:a.jsx(F,{className:"h-4 w-4"})})}),s]})).displayName=d.displayName;u.forwardRef(({className:e,children:s,...t},r)=>a.jsxs(c,{ref:r,className:x("relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors data-[disabled]:pointer-events-none data-[disabled]:opacity-50 focus:bg-accent focus:text-accent-foreground",e),...t,children:[a.jsx("span",{className:"absolute left-2 flex h-3.5 w-3.5 items-center justify-center",children:a.jsx(o,{children:a.jsx(q,{className:"h-2 w-2 fill-current"})})}),s]})).displayName=c.displayName;u.forwardRef(({className:e,inset:s,...t},r)=>a.jsx(m,{ref:r,className:x("px-2 py-1.5 text-sm font-semibold",s&&"pl-8",e),...t})).displayName=m.displayName;u.forwardRef(({className:e,...s},t)=>a.jsx(f,{ref:t,className:x("-mx-1 my-1 h-px bg-muted",e),...s})).displayName=f.displayName;const L=({type:e="riksdagen"})=>{const[s,t]=u.useState(!1),[r,n]=u.useState(null),{toast:i}=h(),l=async(s,a=!0)=>{t(!0),n(s);const r="riksdagen"===e?"fetch-riksdagen-data":"fetch-regeringskansliet-data",l="riksdagen"===e?"riksdagen":"regeringskansliet";await g.from("data_fetch_control").upsert({source:l,data_type:s,should_stop:!1},{onConflict:"source,data_type"});try{const{data:e,error:t}=await g.functions.invoke(r,{body:{dataType:s,paginate:a,maxPages:a?null:1}});if(t)throw t;const n=e.pages?` (${e.pages} sidor)`:"",l=e.errors>0?`, ${e.errors} fel`:"";i({title:"Data hämtad!",description:`${e.inserted} ${s} hämtades${n}${l}`})}catch(d){i({title:"Fel vid hämtning",description:d.message||"Kunde inte hämta data",variant:"destructive"})}finally{t(!1),n(null)}};return a.jsxs("div",{className:"flex gap-2 items-center",children:[s&&r&&a.jsx(p,{variant:"destructive",size:"sm",onClick:()=>(async s=>{try{const a="riksdagen"===e?"riksdagen":"regeringskansliet",{error:t}=await g.from("data_fetch_control").upsert({source:a,data_type:s,should_stop:!0},{onConflict:"source,data_type"});if(t)throw t;i({title:"Stoppsignal skickad",description:"Datahämtningen stoppas vid nästa kontrollpunkt"}),n(null)}catch(a){i({title:"Fel vid stopp",description:a.message,variant:"destructive"})}})(r),children:"Stoppa hämtning"}),a.jsxs(H,{children:[a.jsx(I,{asChild:!0,children:a.jsxs(p,{variant:"outline",size:"sm",disabled:s,children:[s?a.jsx(w,{className:"h-4 w-4 animate-spin mr-2"}):a.jsx(K,{className:"h-4 w-4 mr-2"}),"Hämta data"]})}),a.jsx(M,{align:"end",className:"max-h-[400px] overflow-y-auto",children:"riksdagen"===e?a.jsxs(a.Fragment,{children:[a.jsx(B,{onClick:()=>l("dokument"),children:"Hämta dokument"}),a.jsx(B,{onClick:()=>l("ledamoter"),children:"Hämta ledamöter"}),a.jsx(B,{onClick:()=>l("anforanden"),children:"Hämta anföranden"}),a.jsx(B,{onClick:()=>l("voteringar"),children:"Hämta voteringar"})]}):a.jsxs(a.Fragment,{children:[a.jsx(B,{onClick:()=>l("pressmeddelanden"),children:"Pressmeddelanden"}),a.jsx(B,{onClick:()=>l("propositioner"),children:"Propositioner"}),a.jsx(B,{onClick:()=>l("dokument"),children:"Alla dokument"}),a.jsx(B,{onClick:()=>l("kategorier"),children:"Kategorier"}),a.jsx(B,{onClick:()=>l("departementsserien"),children:"Departementsserien"}),a.jsx(B,{onClick:()=>l("forordningsmotiv"),children:"Förordningsmotiv"}),a.jsx(B,{onClick:()=>l("kommittedirektiv"),children:"Kommittédirektiv"}),a.jsx(B,{onClick:()=>l("lagradsremiss"),children:"Lagradsremiss"}),a.jsx(B,{onClick:()=>l("skrivelse"),children:"Skrivelser"}),a.jsx(B,{onClick:()=>l("sou"),children:"SOU (Statens offentliga utredningar)"}),a.jsx(B,{onClick:()=>l("internationella-overenskommelser"),children:"Internationella överenskommelser"}),a.jsx(B,{onClick:()=>l("faktapromemoria"),children:"Faktapromemoria"}),a.jsx(B,{onClick:()=>l("informationsmaterial"),children:"Informationsmaterial"}),a.jsx(B,{onClick:()=>l("mr-granskningar"),children:"MR-granskningar"}),a.jsx(B,{onClick:()=>l("dagordningar"),children:"Kommenterade dagordningar"}),a.jsx(B,{onClick:()=>l("rapporter"),children:"Rapporter"}),a.jsx(B,{onClick:()=>l("remisser"),children:"Remisser"}),a.jsx(B,{onClick:()=>l("regeringsuppdrag"),children:"Regeringsuppdrag"}),a.jsx(B,{onClick:()=>l("regeringsarenden"),children:"Regeringsärenden"}),a.jsx(B,{onClick:()=>l("sakrad"),children:"Sakråd"}),a.jsx(B,{onClick:()=>l("bistands-strategier"),children:"Biståndsstrategier"}),a.jsx(B,{onClick:()=>l("overenskommelser-avtal"),children:"Överenskommelser och avtal"}),a.jsx(B,{onClick:()=>l("arendeforteckningar"),children:"Ärendeförteckningar"}),a.jsx(B,{onClick:()=>l("artiklar"),children:"Artiklar"}),a.jsx(B,{onClick:()=>l("debattartiklar"),children:"Debattartiklar"}),a.jsx(B,{onClick:()=>l("tal"),children:"Tal"}),a.jsx(B,{onClick:()=>l("ud-avrader"),children:"UD avråder"}),a.jsx(B,{onClick:()=>l("uttalanden"),children:"Uttalanden"})]})})]})]})},O=()=>{const[e,s]=u.useState(!1),[t,r]=u.useState(!1),{toast:n}=h();((e=!0)=>{const{toast:s}=h();u.useEffect(()=>{if(!e)return;const a=setInterval(async()=>{try{const{data:e,error:a}=await g.from("file_download_queue").select("*").eq("status","failed").lt("attempts",3);if(a)throw a;if(e&&e.length>0){console.log(`Auto-retry: Found ${e.length} failed items, retrying...`);const{error:a}=await g.from("file_download_queue").update({status:"pending",error_message:null}).in("id",e.map(e=>e.id));if(a)throw a;await g.functions.invoke("process-file-queue"),s({title:"Auto-retry aktiverad",description:`Försöker ladda om ${e.length} misslyckade filer`})}}catch(e){console.error("Auto-retry error:",e)}},3e5);return()=>clearInterval(a)},[e,s])})(t);const{data:i,refetch:l}=$({queryKey:["file-queue-stats"],queryFn:async()=>{const{data:e}=await g.from("file_download_queue").select("id",{count:"exact",head:!0}).eq("status","pending"),{data:s}=await g.from("file_download_queue").select("id",{count:"exact",head:!0}).eq("status","processing"),{data:a}=await g.from("file_download_queue").select("id",{count:"exact",head:!0}).eq("status","completed"),{data:t}=await g.from("file_download_queue").select("id",{count:"exact",head:!0}).eq("status","failed"),r=((null==e?void 0:e.length)||0)+((null==s?void 0:s.length)||0)+((null==a?void 0:a.length)||0)+((null==t?void 0:t.length)||0);return{pending:(null==e?void 0:e.length)||0,processing:(null==s?void 0:s.length)||0,completed:(null==a?void 0:a.length)||0,failed:(null==t?void 0:t.length)||0,total:r}},refetchInterval:5e3});if(!i||0===i.total)return null;const d=i.total>0?i.completed/i.total*100:0;return a.jsxs(j,{children:[a.jsx(k,{children:a.jsxs(v,{className:"flex items-center justify-between",children:[a.jsx("span",{children:"Filnedladdningskö"}),i&&i.processing>0&&a.jsx(D,{variant:"secondary",className:"animate-pulse",children:"Live"})]})}),a.jsxs(N,{className:"space-y-4",children:[a.jsxs("div",{className:"flex items-center gap-4 p-3 border rounded-lg bg-muted/50",children:[a.jsx(R,{id:"auto",checked:t,onCheckedChange:r}),a.jsx(C,{htmlFor:"auto",children:"Auto-process (var 5:e minut)"})]}),a.jsxs("div",{className:"flex gap-2",children:[a.jsx(p,{onClick:async()=>{s(!0);try{const{error:e}=await g.functions.invoke("process-file-queue");if(e)throw e;n({title:"Filprocessing startad",description:"Filer laddas ner i bakgrunden"}),l()}catch(e){n({title:"Fel vid filprocessing",description:e.message,variant:"destructive"})}finally{s(!1)}},disabled:e||!(null==i?void 0:i.pending),className:"flex-1",children:e?a.jsxs(a.Fragment,{children:[a.jsx(w,{className:"mr-2 h-4 w-4 animate-spin"}),"Bearbetar..."]}):a.jsxs(a.Fragment,{children:[a.jsx(S,{className:"mr-2 h-4 w-4"}),"Kör nu"]})}),(null==i?void 0:i.failed)>0&&a.jsxs(p,{variant:"outline",onClick:async()=>{try{const{error:e}=await g.from("file_download_queue").update({status:"pending",attempts:0,error_message:null}).eq("status","failed");if(e)throw e;n({title:"Misslyckade filer återställda",description:"Filerna kommer försökas laddas ner igen"}),l()}catch(e){n({title:"Fel vid återställning",description:e.message,variant:"destructive"})}},children:["Återställ (",i.failed,")"]})]}),a.jsxs("div",{children:[a.jsxs("div",{className:"flex justify-between text-sm mb-2",children:[a.jsx("span",{children:"Totalt framsteg"}),a.jsxs("span",{className:"font-medium",children:[Math.round(d),"%"]})]}),a.jsx(b,{value:d,className:"h-2"})]}),a.jsxs("div",{className:"grid grid-cols-4 gap-4",children:[a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx(_,{className:"h-4 w-4 text-yellow-500"}),a.jsxs("div",{children:[a.jsx("div",{className:"text-2xl font-bold",children:i.pending}),a.jsx("div",{className:"text-xs text-muted-foreground",children:"Väntande"})]})]}),a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx(z,{className:"h-4 w-4 text-info"}),a.jsxs("div",{children:[a.jsx("div",{className:"text-2xl font-bold",children:i.processing}),a.jsx("div",{className:"text-xs text-muted-foreground",children:"Processar"})]})]}),a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx(P,{className:"h-4 w-4 text-success"}),a.jsxs("div",{children:[a.jsx("div",{className:"text-2xl font-bold",children:i.completed}),a.jsx("div",{className:"text-xs text-muted-foreground",children:"Klara"})]})]}),a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx(A,{className:"h-4 w-4 text-error"}),a.jsxs("div",{children:[a.jsx("div",{className:"text-2xl font-bold",children:i.failed}),a.jsx("div",{className:"text-xs text-muted-foreground",children:"Misslyckade"})]})]})]})]})]})};export{L as D,O as F};
